<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>双人火柴人对战（落石 + 子弹）</title>
<style>
    body {
        margin: 0;
        background: #111827;
        overflow: hidden;
        color: white;
        font-family: Arial;
        text-align: center;
    }

    #game {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: radial-gradient(circle at center, #1f2937, #0f172a);
        overflow: hidden;
    }

    .player {
        position: absolute;
        width: 40px;
        height: 60px;
        background-color: transparent;
        background-position: center;
        background-size: contain;
        background-repeat: no-repeat;
    }

    /* 隐藏原先的伪元素（改用图片） */
    .player::after, .player::before {
        display: none;
    }

    /* 子弹 */
    .bullet {
        position: absolute;
        width: 10px;
        height: 4px;
        background: yellow;
        border-radius: 2px;
    }

    /* 落石 */
    .rock {
        position: absolute;
        width: 30px;
        height: 30px;
        background: gray;
        border-radius: 5px;
    }
    
    /* 平台 */
    .platform {
        position: absolute;
        height: 12px;
        background: #34d399;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    #info {
        position: absolute;
        top: 10px;
        width: 100%;
        font-size: 20px;
    }

    #winner {
        display: none;
        font-size: 40px;
        margin-top: 20vh;
    }

    #restart {
        display: none;
        padding: 12px 25px;
        background: #60a5fa;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        font-size: 20px;
        color: black;
    }
</style>
</head>
<body>

<div id="game">
    <div id="info">
        <b>操作说明：</b><br>
        玩家1： A 左 | D 右 | W 跳 | F 发射子弹 | G 冲刺技能<br>
        玩家2： ← 左 | → 右 | ↑ 跳 | / 发射子弹 | K 冲刺技能
    </div>

    <div id="winner"></div>
    <button id="restart" onclick="restart()">重新开始</button>
</div>

<script>
const game = document.getElementById("game");
const winnerText = document.getElementById("winner");
const restartBtn = document.getElementById("restart");

const PLAYER_W = 20;
const PLAYER_H = 60;

let players = [
    { x: 200, y: 500, vx: 0, vy: 0, img: "https://www.keaitupian.cn/cjpic/frombd/1/253/728328963/1751682274.jpg", alive: true, skillTimer: 0, skillCooldown: 180, isDashing: false, dashTimer: 0, dashVel: 0, jumpCount: 0, lastTap: { left: 0, right: 0 } },
    { x: 900, y: 500, vx: 0, vy: 0, img: "https://c-ssl.dtstatic.com/uploads/blog/202303/25/20230325215809_01644.thumb.400_0.jpeg", alive: true, skillTimer: 0, skillCooldown: 180, isDashing: false, dashTimer: 0, dashVel: 0, jumpCount: 0, lastTap: { left: 0, right: 0 } }
];

let keys = {};
let bullets = [];
let rocks = [];
let gravity = 0.4;
let ground = window.innerHeight - 80;

/* 创建玩家元素 */
players.forEach((p, i) => {
    p.el = document.createElement("div");
    p.el.className = "player";
    if (p.img) {
        p.el.style.backgroundImage = `url(${p.img})`;
        p.el.style.backgroundSize = "contain";
        p.el.style.backgroundRepeat = "no-repeat";
        p.el.style.backgroundPosition = "center";
    } else {
        p.el.style.background = p.color;
    }
    p.el.style.width = PLAYER_W + "px";
    p.el.style.height = PLAYER_H + "px";
    game.appendChild(p.el);
});

/* 键盘监听 */
// 处理按键与双击检测
document.addEventListener("keydown", e => {
    if (!keys[e.key]) handleTap(e.key);
    keys[e.key] = true;
});
document.addEventListener("keyup", e => keys[e.key] = false);

function handleTap(key) {
    const now = performance.now();
    // 玩家1: a / d / s ； 玩家2: ArrowLeft / ArrowRight / ArrowDown
    // 双击方向触发冲刺
    // 玩家1 左
    if (key === "a") {
        const p = players[0];
        if (now - p.lastTap.left < 300 && p.skillTimer <= 0) {
            // 触发冲刺向左
            p.isDashing = true;
            p.dashTimer = 12;
            p.skillTimer = p.skillCooldown;
            p.dashVel = -12;
            p.vx = p.dashVel;
            p.lastTap.left = 0;
        } else {
            p.lastTap.left = now;
        }
    }
    // 玩家1 右
    if (key === "d") {
        const p = players[0];
        if (now - p.lastTap.right < 300 && p.skillTimer <= 0) {
            p.isDashing = true;
            p.dashTimer = 12;
            p.skillTimer = p.skillCooldown;
            p.dashVel = 12;
            p.vx = p.dashVel;
            p.lastTap.right = 0;
        } else {
            p.lastTap.right = now;
        }
    }
    // 玩家1 下键发射子弹
    if (key === "s") {
        shoot(0);
    }

    // 玩家2 左
    if (key === "ArrowLeft") {
        const p = players[1];
        if (now - p.lastTap.left < 300 && p.skillTimer <= 0) {
            p.isDashing = true;
            p.dashTimer = 12;
            p.skillTimer = p.skillCooldown;
            p.dashVel = -12;
            p.vx = p.dashVel;
            p.lastTap.left = 0;
        } else {
            p.lastTap.left = now;
        }
    }
    // 玩家2 右
    if (key === "ArrowRight") {
        const p = players[1];
        if (now - p.lastTap.right < 300 && p.skillTimer <= 0) {
            p.isDashing = true;
            p.dashTimer = 12;
            p.skillTimer = p.skillCooldown;
            p.dashVel = 12;
            p.vx = p.dashVel;
            p.lastTap.right = 0;
        } else {
            p.lastTap.right = now;
        }
    }
    // 玩家2 下键发射子弹
    if (key === "ArrowDown") {
        shoot(1);
    }
}

/* 发射子弹 */
function shoot(i) {
    if (!players[i].alive) return;

    let dir = i === 0 ?
        (keys["d"] ? 1 : keys["a"] ? -1 : 1) :
        (keys["ArrowRight"] ? 1 : keys["ArrowLeft"] ? -1 : -1);

    let b = {
        x: players[i].x + PLAYER_W / 2,
        y: players[i].y + PLAYER_H / 2,
        vx: dir * 8,
        owner: i
    };
    b.el = document.createElement("div");
    b.el.className = "bullet";
    game.appendChild(b.el);
    bullets.push(b);
}

/* 落石生成 */
function spawnRock() {
    let r = {
        x: Math.random() * window.innerWidth,
        y: -30,
        vy: Math.random() * 2 + 3
    };
    r.el = document.createElement("div");
    r.el.className = "rock";
    r.el.style.left = r.x + "px";
    game.appendChild(r.el);
    rocks.push(r);

    setTimeout(spawnRock, 1000 + Math.random() * 1000);
}
spawnRock();

/* 平台系统 */
let platforms = [];
function createPlatform(x, y, width, opts = {}) {
    let plat = { x, y, width };
    plat.type = opts.type || "static"; // static | moving | disappear
    plat.baseY = y;
    plat.amplitude = opts.amplitude || 0;
    plat.speed = opts.speed || 0;
    plat.phase = opts.phase || 0;
    plat.lifespan = opts.lifespan || 0; // frames for disappear type
    plat.el = document.createElement("div");
    plat.el.className = "platform";
    plat.el.style.left = plat.x + "px";
    plat.el.style.top = plat.y + "px";
    plat.el.style.width = plat.width + "px";
    game.appendChild(plat.el);
    platforms.push(plat);
    return plat;
}

ground = window.innerHeight - 80;
// 一些示例平台
createPlatform(300, ground - 150, 160);
createPlatform(700, ground - 250, 120);
createPlatform(Math.max(100, window.innerWidth / 2 - 60), ground - 350, 140);
// frame counter for animations
let frameCount = 0;

// 动态生成平台（最多 7 个）
function spawnDynamicPlatform() {
    if (platforms.length >= 7) return;
    const w = 80 + Math.random() * 160;
    const x = Math.random() * (window.innerWidth - w - 40) + 20;
    const baseY = 120 + Math.random() * (ground - 220);
    const r = Math.random();
    if (r < 0.35) {
        // moving
        createPlatform(x, baseY, w, {
            type: "moving",
            amplitude: 30 + Math.random() * 80,
            speed: 0.004 + Math.random() * 0.02,
            phase: Math.random() * Math.PI * 2
        });
    } else if (r < 0.7) {
        // disappearing
        createPlatform(x, baseY, w, {
            type: "disappear",
            lifespan: 300 + Math.floor(Math.random() * 600)
        });
    } else {
        // static
        createPlatform(x, baseY, w, { type: "static" });
    }
}

// 周期生成平台
setInterval(spawnDynamicPlatform, 1200);

window.addEventListener("resize", () => {
    ground = window.innerHeight - 80;
});

/* 主循环 */
function loop() {
    players.forEach((p, i) => {
        if (!p.alive) return;

        // 控制
        if (i === 0) { // 玩家1: A D W F
            if (keys["a"]) p.vx = -4;
            else if (keys["d"]) p.vx = 4;
            else p.vx = 0;
            // 跳跃（支持二段跳）：按下触发一次，释放后可再次触发
            if (keys["w"] && p.jumpCount < 2) { p.vy = -10; p.jumpCount++; keys["w"] = false; }
            if (keys["f"]) { keys["f"] = false; shoot(0); }
            // 技能：G 冲刺
            if (keys["g"] && p.skillTimer <= 0) {
                keys["g"] = false;
                p.isDashing = true;
                p.dashTimer = 12;
                p.skillTimer = p.skillCooldown;
                let dir = keys["d"] ? 1 : keys["a"] ? -1 : (p.vx >= 0 ? 1 : -1);
                p.dashVel = dir * 12;
                p.vx = p.dashVel;
            }
        } else { // 玩家2: ← → ↑ /
            if (keys["ArrowLeft"]) p.vx = -4;
            else if (keys["ArrowRight"]) p.vx = 4;
            else p.vx = 0;
            if (keys["ArrowUp"] && p.jumpCount < 2) { p.vy = -10; p.jumpCount++; keys["ArrowUp"] = false; }
            if (keys["/"]) { keys["/"] = false; shoot(1); }
            // 技能：K 冲刺
            if (keys["k"] && p.skillTimer <= 0) {
                keys["k"] = false;
                p.isDashing = true;
                p.dashTimer = 12;
                p.skillTimer = p.skillCooldown;
                let dir = keys["ArrowRight"] ? 1 : keys["ArrowLeft"] ? -1 : (p.vx >= 0 ? 1 : -1);
                p.dashVel = dir * 12;
                p.vx = p.dashVel;
            }
        }

        // 物理移动
        p.vy += gravity;
        p.y += p.vy;
        // 冲刺期间保持冲刺速度
        if (p.isDashing) {
            p.dashTimer--;
            p.vx = p.dashVel;
            if (p.dashTimer <= 0) {
                p.isDashing = false;
                p.dashVel = 0;
            }
        }
        p.x += p.vx;

        // 技能冷却计时
        if (p.skillTimer > 0) p.skillTimer--;

        // 平台碰撞检测（从上方落下时）
        for (let pi = platforms.length - 1; pi >= 0; pi--) {
            const plat = platforms[pi];
            if (p.vy >= 0 &&
                p.x + PLAYER_W > plat.x &&
                p.x < plat.x + plat.width &&
                p.y + PLAYER_H >= plat.y &&
                p.y + PLAYER_H <= plat.y + p.vy + 10) {
                p.y = plat.y - PLAYER_H;
                p.vy = 0;
                // 着地重置二段跳
                p.jumpCount = 0;
            }
        }

        if (p.y > ground) { p.y = ground; p.vy = 0; p.jumpCount = 0; }
        if (p.x < 0) p.x = 0;
        if (p.x > window.innerWidth - PLAYER_W) p.x = window.innerWidth - PLAYER_W;

        p.el.style.left = p.x + "px";
        p.el.style.top = p.y + "px";
    });

    /* 子弹更新 */
    bullets.forEach((b, idx) => {
        b.x += b.vx;
        b.el.style.left = b.x + "px";
        b.el.style.top = b.y + "px";

        // 飞出屏幕
        if (b.x < 0 || b.x > window.innerWidth) {
            b.el.remove();
            bullets.splice(idx, 1);
        }

        // 检测击中
        players.forEach((p, i) => {
            if (!p.alive || b.owner === i) return;
            const px = p.x + PLAYER_W / 2;
            const py = p.y + PLAYER_H / 2;
            if (Math.abs(b.x - px) < PLAYER_W && Math.abs(b.y - py) < PLAYER_H / 2 + 10) {
                die(i);
            }
        });
    });

    /* 平台更新：移动 / 消失 / 重绘 */
    for (let i = platforms.length - 1; i >= 0; i--) {
        const plat = platforms[i];
        if (plat.type === "moving") {
            plat.y = plat.baseY + Math.sin(frameCount * plat.speed + plat.phase) * plat.amplitude;
            plat.el.style.top = plat.y + "px";
        } else {
            // 静态 or disappear use baseY unless lifespan causes blink
            plat.el.style.top = plat.y + "px";
        }

        if (plat.type === "disappear") {
            plat.lifespan--;
            // 快要消失时开始闪烁
            if (plat.lifespan < 60) {
                plat.el.style.opacity = (Math.floor(plat.lifespan / 6) % 2) ? "0.3" : "1";
            }
            if (plat.lifespan <= 0) {
                plat.el.remove();
                platforms.splice(i, 1);
            }
        }
    }

    /* 落石更新 */
    rocks.forEach((r, idx) => {
        r.y += r.vy;
        r.el.style.top = r.y + "px";

        // 砸中玩家
        players.forEach((p, i) => {
            if (!p.alive) return;
            if (Math.abs(r.x - p.x) < 20 && Math.abs(r.y - p.y) < 50) {
                die(i);
            }
        });

        if (r.y > window.innerHeight) {
            r.el.remove();
            rocks.splice(idx, 1);
        }
    });

    // 更新顶部信息（技能冷却显示）
    let infoHtml = `<b>操作说明：</b><br>
        玩家1： A 左（双击冲刺） | D 右（双击冲刺） | W 跳（双段） | S 向下冲刺 | F 发射子弹（冷却：${Math.max(0, Math.ceil(players[0].skillTimer/60))}s）<br>
        玩家2： ← 左（双击冲刺） | → 右（双击冲刺） | ↑ 跳（双段） | ↓ 向下冲刺 | / 发射子弹（冷却：${Math.max(0, Math.ceil(players[1].skillTimer/60))}s）`;
    document.getElementById("info").innerHTML = infoHtml;
    frameCount++;
    requestAnimationFrame(loop);
}
loop();

/* 玩家死亡 */
function die(i) {
    if (!players[i].alive) return;
    players[i].alive = false;
    players[i].el.style.opacity = "0.2";

    let winner = i === 0 ? "玩家2 获胜！" : "玩家1 获胜！";
    winnerText.innerHTML = winner;
    winnerText.style.display = "block";
    restartBtn.style.display = "inline-block";
}

/* 重新开始 */
function restart() {
    window.location.reload();
}
</script>

</body>
</html>
